

































<title>Percona Distribution for PostgreSQL &mdash; Extensions</title>

<head>
    


    

    <link rel="top" title="" href="" />
    
    <link rel="next" title="Uninstall" href="uninstalling.html" />
    
    
</head>

<body>
    
<link rel="stylesheet" href="https://unicons.iconscout.com/release/v3.0.3/css/line.css" type="text/css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" type="text/css">
<link rel="stylesheet" href="css/toctree.css" type="text/css">
<link rel="stylesheet" href="css/percona.css" type="text/css">

    

    <div class="container">
        <div class="document row">
            <div class="documentwrapper col-md-9 col-md-push-3">
                
<div class="related row">
    <ul class="nav nav-pills">
        
        <li class="right" style="margin-right: 10px">
            <a href="uninstalling.html" title="Uninstall">Next</a>
        </li>
        
        
        <li class="right" style="margin-right: 10px">
            <a href="minor-upgrade.html" title="Minor Upgrade of Percona Distribution for PostgreSQL">Previous</a>
        </li>
        
        <li>
            <a href="">Home</a>
        </li>
    </ul>
</div>

                

<div class="small">
    <ul class="list-inline">
        <li class="left">
            <a href="https://github.com/percona/postgresql-docs/issues/new?title= 'Extensions' (pg-stat-monitor.html)&body="
                target="_blank" title=""></a>
        </li>
        <li class="pull-right">
            <a href="https://github.com/percona/postgresql-docs/edit/13/docs/pg-stat-monitor.md" target="_blank" title="Edit this page on GitHub in Markdown format"><i class="uil uil-pen"></i> <b>Edit this page</b></a>
        </li>
    </ul>
</div>


                <div class="bodywrapper">
                    <div class="body">
                        <h1 id="pg_stat_monitor">pg_stat_monitor<a class="headerlink" href="#pg_stat_monitor" title="Permanent link">&para;</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is a technical preview feature and it is subject to further changes.</p>
</div>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p><code>pg_stat_monitor</code> is a PostgreSQL Query Performance Monitoring
tool. It collects statistics data and writes it in a storage unit called <em>bucket</em>. The data is added and stored in a bucket for the defined period – the bucket lifetime.</p>
<p>You can specify the following:</p>
<ul>
<li>
<p>The number of buckets. Together they form a bucket chain.</p>
</li>
<li>
<p>Bucket size. This is the amount of shared memory allocated for buckets. Memory is divided equally among buckets.</p>
</li>
<li>
<p>Bucket lifetime.</p>
</li>
</ul>
<p>When a bucket lifetime expires, <code>pg_stat_monitor</code> resets all statistics and writes the data in the next bucket in the chain. When the last bucket’s lifetime expires, <code>pg_stat_monitor</code> returns to the first bucket.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The contents of the bucket will be overwritten. In order not to lose the data, make sure to read the bucket before <code>pg_stat_monitor</code> starts writing new data to it.</p>
</div>
<h2 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">&para;</a></h2>
<p>After the <a href="installing.html#install-percona-distribution-for-postgresql-packages">installation</a>, <code>pg_stat_monitor</code> requires additional setup in order to use it with PostgreSQL. The setup steps are the following:</p>
<ol>
<li>Add <code>pg_stat_monitor</code> in the <code>shared_preload_libraries</code> configuration parameter.</li>
</ol>
<p>The recommended way to modify PostgreSQL configuration file is using the <a href="https://www.postgresql.org/docs/13/sql-altersystem.html">ALTER SYSTEM</a> command. Connect to psql and use the following command:</p>
<div class="highlight"><pre><span></span><code>$ ALTER SYSTEM SET shared_preload_libraries = &#39;pg_stat_monitor&#39;;
</code></pre></div>
<p>The parameter value is written to the <code>postgresql.auto.conf</code> file which is read in addition with <code>postgresql.conf</code> file.</p>
<ol>
<li>
<p>Start or restart the PostgreSQL instance to enable <code>pg_stat_monitor</code>. Use the following command for restart:</p>
<ul>
<li>On Debian and Ubuntu:</li>
</ul>
<div class="highlight"><pre><span></span><code>$ sudo systemctl restart postgresql.service
</code></pre></div>
<ul>
<li>On Red Hat Enterprise Linux and CentOS:</li>
</ul>
<div class="highlight"><pre><span></span><code>$ sudo systemctl restart postgresql-13
</code></pre></div>
</li>
<li>
<p>Create the extension. Connect to <code>psql</code> and use the following command:</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code>$ CREATE EXTENSION pg_stat_monitor;
</code></pre></div>
<h2 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">&para;</a></h2>
<p><code>pg_stat_monitor</code> provides two views:</p>
<ul>
<li>
<p><code>pg_stat_monitor</code> is the view where statistics data is presented.</p>
</li>
<li>
<p><code>pg_stat_monitor_settings</code> shows available configuration options which you can change. To learn more, see Changing the configuration.</p>
</li>
</ul>
<p>Use the following query to view what metrics <code>pg_stat_monitor</code> can collect:</p>
<div class="highlight"><pre><span></span><code>$ \d pg_stat_monitor;
</code></pre></div>
<p><strong>Output</strong></p>
<div class="highlight"><pre><span></span><code>                     View &quot;public.pg_stat_monitor&quot;
       Column        |           Type           | Collation | Nullable | Default
---------------------+--------------------------+-----------+----------+---------
 bucket              | integer                  |           |          |
 bucket_start_time   | timestamp with time zone |           |          |
 userid              | oid                      |           |          |
 dbid                | oid                      |           |          |
 client_ip           | inet                     |           |          |
 queryid             | text                     |           |          |
 query               | text                     |           |          |
 application_name    | text                     |           |          |
 relations           | text[]                   |           |          |
 cmd_type            | text[]                   |           |          |
 elevel              | integer                  |           |          |
 sqlcode             | integer                  |           |          |
 message             | text                     |           |          |
 plans               | bigint                   |           |          |
 plan_total_time     | double precision         |           |          |
 plan_min_timei      | double precision         |           |          |
 plan_max_time       | double precision         |           |          |
 plan_mean_time      | double precision         |           |          |
 plan_stddev_time    | double precision         |           |          |
 calls               | bigint                   |           |          |
 total_time          | double precision         |           |          |
 min_time            | double precision         |           |          |
 max_time            | double precision         |           |          |
 mean_time           | double precision         |           |          |
 stddev_time         | double precision         |           |          |
 rows                | bigint                   |           |          |
 shared_blks_hit     | bigint                   |           |          |
 shared_blks_read    | bigint                   |           |          |
 shared_blks_dirtied | bigint                   |           |          |
 shared_blks_written | bigint                   |           |          |
 local_blks_hit      | bigint                   |           |          |
 local_blks_read     | bigint                   |           |          |
 local_blks_dirtied  | bigint                   |           |          |
 local_blks_written  | bigint                   |           |          |
 temp_blks_read      | bigint                   |           |          |
 temp_blks_written   | bigint                   |           |          |
 blk_read_time       | double precision         |           |          |
 blk_write_time      | double precision         |           |          |
 resp_calls          | text[]                   |           |          |
 cpu_user_time       | double precision         |           |          |
 cpu_sys_time        | double precision         |           |          |
</code></pre></div>
<p>For example, to view the IP address of the client application that made the query, run the following command:</p>
<div class="highlight"><pre><span></span><code>$ SELECT userid::regrole, datname, substr(query,0, 50) AS query, calls, client_ip
  FROM pg_stat_monitor, pg_database
  WHERE dbid = oid;

  userid  | datname  |                       query                       | calls | client_ip
----------+----------+---------------------------------------------------+-------+-----------
 postgres | postgres | select bucket, bucket_start_time, query,calls fro |     1 | 127.0.0.1
 postgres | postgres | SELECT c.relchecks, c.relkind, c.relhasindex, c.r |     1 | 127.0.0.1
 postgres | postgres | SELECT  userid,  total_time, min_time, max_time,  |     1 | 127.0.0.1
</code></pre></div>
<p>Find more usage examples  in <a href="https://github.com/percona/pg_stat_monitor/blob/REL0_7_0_STABLE/docs/USER_GUIDE.md">pg_stat_monitor User Guide</a>.</p>
<h2 id="changing-the-configuration">Changing the configuration<a class="headerlink" href="#changing-the-configuration" title="Permanent link">&para;</a></h2>
<p>Run the following query to list available configuration parameters.</p>
<div class="highlight"><pre><span></span><code>$ SELECT name,description FROM pg_stat_monitor_settings;
</code></pre></div>
<p><strong>Output</strong></p>
<div class="highlight"><pre><span></span><code>name                      |                            description
-----------------------------------------------+-------------------------------------------------------------------
 pg_stat_monitor.pgsm_max                      | Sets the maximum number of statements tracked by pg_stat_monitor.
 pg_stat_monitor.pgsm_query_max_len            | Sets the maximum length of query.
 pg_stat_monitor.pgsm_enable                   | Enable/Disable statistics collector.
 pg_stat_monitor.pgsm_track_utility            | Selects whether utility commands are tracked.
 pg_stat_monitor.pgsm_normalized_query         | Selects whether save query in normalized format.
 pg_stat_monitor.pgsm_max_buckets              | Sets the maximum number of buckets.
 pg_stat_monitor.pgsm_bucket_time              | Sets the time in seconds per bucket.
 pg_stat_monitor.pgsm_object_cache             | Sets the maximum number of object cache
 pg_stat_monitor.pgsm_respose_time_lower_bound | Sets the time in millisecond.
 pg_stat_monitor.pgsm_respose_time_step        | Sets the response time steps in millisecond.
 pg_stat_monitor.pgsm_query_shared_buffer      | Sets the query shared_buffer size.
</code></pre></div>
<p>You can change a parameter by setting a new value in the configuration file. Some parameters require server restart to apply a new value. For others, configuration reload is enough. Refer to the <a href="https://github.com/percona/pg_stat_monitor/blob/REL0_7_0_STABLE/docs/USER_GUIDE.md#configuration">configuration section</a> of the <code>pg_stat_monitor</code> documentation for the parameters’ description, how you can change their values and if the server restart is required to apply them.</p>
<p>As an example, let’s set the bucket lifetime from default 60 seconds to 100 seconds. Use the <strong>ALTER SYSTEM</strong> command:</p>
<div class="highlight"><pre><span></span><code>$ ALTER SYSTEM set pg_stat_monitor.pgsm_bucket_time = 100;
</code></pre></div>
<p>Restart the server to apply the change:</p>
<ul>
<li>On Debia and Ubuntu</li>
</ul>
<div class="highlight"><pre><span></span><code>$ sudo systemctl restart restart postgresql.service
</code></pre></div>
<ul>
<li>On Red Hat Enterprise Linux and CentOS:</li>
</ul>
<div class="highlight"><pre><span></span><code>$ sudo systemctl restart postgresql-13
</code></pre></div>
<p>Verify the updated parameter:</p>
<div class="highlight"><pre><span></span><code>$ SELECT name, value
  FROM pg_stat_monitor_settings
  WHERE name = &#39;pg_stat_monitor.pgsm_bucket_time&#39;;

                 name               | value
  ----------------------------------+-------
   pg_stat_monitor.pgsm_bucket_time |   100
</code></pre></div>
<div class="admonition seealso">
<p class="admonition-title">Seealso</p>
<p><a href="https://github.com/percona/pg_stat_monitor/blob/REL0_7_0_STABLE/README.md"><code>pg_stat_monitor</code> Documentation</a></p>
<p>Percona Blog:</p>
<p><a href="https://www.percona.com/blog/2021/01/19/pg_stat_monitor-a-new-way-of-looking-at-postgresql-metrics/">pg_stat_monitor: A New Way Of Looking At PostgreSQL Metrics</a></p>
</div>
                    </div>
                </div>
                
<div class="small">
    <ul class="list-inline">
        
        <li class="left">
            <i class="uil uil-refresh"></i> Page updated 2021-04-28
        </li>
        
    </ul>
</div>

                
<div class="related row">
    <ul class="nav nav-pills">
        
        <li class="right" style="margin-right: 10px">
            <a href="uninstalling.html" title="Uninstall">Next</a>
        </li>
        
        
        <li class="right" style="margin-right: 10px">
            <a href="minor-upgrade.html" title="Minor Upgrade of Percona Distribution for PostgreSQL">Previous</a>
        </li>
        
        <li>
            <a href="">Home</a>
        </li>
    </ul>
</div>

            </div>
            
<div class="sphinxsidebar col-md-3 col-md-pull-9">
    <div class="sphinxsidebarwrapper">
        {@ product_logo @}
        {@ product_pdf_download @}
        
<section class="select-wrapper" id="version-select-wrapper">
    <!-- Empty locator section for version selector -->
</section>

        <h3 id="toctree-heading"><a href="">Contents</a></h3>
        

<ul class="toctree" id="toctree">


<li class="toctree-l1">
    <a class="reference internal" href="index.html">Percona Distribution for PostgreSQL 13 Documentation</a>




<li class="toctree-l1">
    <a class="reference internal" href="installing.html">Installation and Upgrade</a>




<ul class="toctree" id="toctree">


<li class="toctree-l2">
    <a class="reference internal" href="major-upgrade.html">Upgrading Percona Distribution for PostgreSQL from 12 to 13</a>




<li class="toctree-l2">
    <a class="reference internal" href="minor-upgrade.html">Minor Upgrade of Percona Distribution for PostgreSQL</a>



</ul>





<li class="toctree-l1">
    <a class="reference internal" href="pg-stat-monitor.html">Extensions</a>




<li class="toctree-l1">
    <a class="reference internal" href="uninstalling.html">Uninstall</a>




<li class="toctree-l1">
    <a class="reference internal" href="release-notes.html">Release Notes</a>




<ul class="toctree" id="toctree">


<li class="toctree-l2">
    <a class="reference internal" href="release-notes-v13.0.html">Percona Distribution for PostgreSQL 13.0</a>




<li class="toctree-l2">
    <a class="reference internal" href="release-notes-v13.1.html">Percona Distribution for PostgreSQL 13.1</a>




<li class="toctree-l2">
    <a class="reference internal" href="release-notes-v13.2.html">Percona Distribution for PostgreSQL 13.2</a>




<li class="toctree-l2">
    <a class="reference internal" href="release-notes-v13.2.upd.html">Percona Distribution for PostgreSQL 13.2 Update</a>




<li class="toctree-l2">
    <a class="reference internal" href="release-notes-v13.2.upd2.html">Percona Distribution for PostgreSQL 13.2 Second Update</a>



</ul>





<li class="toctree-l1">
    <a class="reference internal" href="licensing.html">Reference</a>



</ul>


        

<h4>Previous page</h4>
<p class="topless">
    <a href="minor-upgrade.html" title="previous chapter">Minor Upgrade of Percona Distribution for PostgreSQL</a>
</p>


<h4>Next page</h4>
<p class="topless">
    <a href="uninstalling.html" title="next chapter">Uninstall</a>
</p>


        {@ product_series @}
    </div>
</div>

            <div class="clearer"></div>
        </div>
    </div>
</body>